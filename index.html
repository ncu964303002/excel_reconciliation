<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Ë≥áÊñôÊØîÂ∞çÂ∑•ÂÖ∑</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .file-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }

        .file-stats {
            font-size: 12px;
            color: #666;
        }

        .file-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .amount-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .amount-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .amount-toggle input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .amount-fields {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .amount-fields.show {
            display: grid;
        }

        .helper-text {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .comparison-mode {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .mode-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .mode-options {
            display: grid;
            gap: 10px;
        }

        .mode-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-option input[type="radio"] {
            cursor: pointer;
        }

        .mode-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .mode-desc {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .primary-selector {
            margin-top: 15px;
            display: none;
        }

        .primary-selector.show {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-export {
            background: #28a745;
            color: white;
        }

        .conclusion-report {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .report-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .summary-box {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            opacity: 0.9;
        }

        .summary-value {
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 18px;
            border: none;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .highlight-warning {
            background: #fff3cd !important;
        }

        .highlight-error {
            background: #f8d7da !important;
        }

        @media (max-width: 968px) {
            .file-config {
                grid-template-columns: 1fr;
            }

            .amount-fields {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Excel Ë≥áÊñôÊØîÂ∞çÂ∑•ÂÖ∑</h1>
            <p>Â∞àÊ•≠ÁöÑÂ§öÊ™îÊ°àË≥áÊñôÂãæÁ®ΩÊØîÂ∞çÁ≥ªÁµ±</p>
        </div>

        <div class="content">
            <!-- ‰∏äÂÇ≥Ê™îÊ°à -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">1</span>
                    ‰∏äÂÇ≥Ê™îÊ°à
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>ÈªûÊìäÊàñÊãñÊõ≥Ê™îÊ°àÂà∞Ê≠§Ëôï</h3>
                    <p style="color: #666; margin-top: 10px;">ÊîØÊè¥ .xlsx Âíå .xls Ê†ºÂºè</p>
                    <input type="file" id="fileInput" style="display: none;" accept=".xlsx,.xls" multiple>
                </div>
                <div id="uploadedFiles" style="margin-top: 20px;"></div>
            </div>

            <!-- ÊØîÂ∞çË®≠ÂÆö -->
            <div class="section" id="configSection" style="display: none;">
                <div class="section-title">
                    <span class="step-number">2</span>
                    ÊØîÂ∞çË®≠ÂÆö
                </div>
                
                <div class="comparison-mode">
                    <div class="mode-title">ÊØîÂ∞çÊ®°Âºè</div>
                    <div class="mode-options">
                        <label class="mode-option selected">
                            <input type="radio" name="mode" value="union" checked onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">ËÅØÈõÜ</div>
                                <div class="mode-desc">È°ØÁ§∫ÊâÄÊúâÊ™îÊ°à‰∏≠Âá∫ÁèæÁöÑ Key</div>
                            </div>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="intersection" onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">‰∫§ÈõÜ</div>
                                <div class="mode-desc">ÂÉÖÈ°ØÁ§∫ÊâÄÊúâÊ™îÊ°àÂÖ±ÂêåÁöÑ Key</div>
                            </div>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="primary" onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">ÊåáÂÆö‰∏ªÊ™î</div>
                                <div class="mode-desc">‰ª•Êüê‰∏ÄÊ™îÊ°àÁÇ∫Âü∫Ê∫ñÈÄ≤Ë°åÊØîÂ∞ç</div>
                            </div>
                        </label>
                    </div>
                    <div class="primary-selector" id="primarySelector">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">‰∏ªË¶ÅÊ™îÊ°à</label>
                        <select id="primaryFile" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="performAnalysis()" style="margin-top: 20px;">
                    ÈñãÂßãÊØîÂ∞ç
                </button>
            </div>

            <!-- ÁµêÊûú -->
            <div id="resultSection" style="display: none;">
                <div class="conclusion-report">
                    <div class="report-title">ÊØîÂ∞çÁµêÊûú</div>
                    
                    <div class="stats-grid" id="statsGrid"></div>

                    <div class="summary-box" id="summaryBox"></div>
                </div>

                <!-- ÂúñË°® -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Ë≥áÊñôÂàÜÂ∏É</div>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Ê™îÊ°àË¶ÜËìãÁéá</div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Ë©≥Á¥∞Ë≥áÊñô -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="section-title" style="margin: 0;">
                            Ë©≥Á¥∞Ë≥áÊñô
                        </div>
                        <button class="btn btn-export" onclick="exportResults()">
                            ÂåØÂá∫ Excel
                        </button>
                    </div>
                    
                    <div class="tabs" id="tabs"></div>
                    <div id="tabContent" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let filesData = [];
        let analysisResults = null;

        // ‰∏äÂÇ≥ËôïÁêÜ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.onclick = () => fileInput.click();
        uploadArea.ondragover = (e) => { e.preventDefault(); uploadArea.style.background = '#f0f4ff'; };
        uploadArea.ondragleave = () => { uploadArea.style.background = 'white'; };
        uploadArea.ondrop = (e) => {
            e.preventDefault();
            uploadArea.style.background = 'white';
            handleFiles(e.dataTransfer.files);
        };
        fileInput.onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) {
            for (let file of files) {
                if (file.name.match(/\.(xlsx|xls)$/)) {
                    const data = await readExcel(file);
                    uploadedFiles.push(file);
                    filesData.push(data);
                }
            }
            displayFiles();
            if (uploadedFiles.length >= 2) {
                document.getElementById('configSection').style.display = 'block';
                updatePrimarySelector();
            }
        }

        function readExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws);
                    const columns = data.length > 0 ? Object.keys(data[0]) : [];
                    resolve({ data, columns, sheetName: wb.SheetNames[0] });
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function displayFiles() {
            const container = document.getElementById('uploadedFiles');
            
            container.innerHTML = uploadedFiles.map((file, i) => `
                <div class="file-item">
                    <div class="file-header">
                        <div class="file-info">
                            <div class="file-name">üìÑ ${file.name}</div>
                            <div class="file-stats">${filesData[i].data.length} Á≠Ü | ${filesData[i].columns.length} Ê¨Ñ‰Ωç</div>
                        </div>
                        <button class="btn btn-remove" onclick="removeFile(${i})">ÁßªÈô§</button>
                    </div>

                    <div class="file-config">
                        <div class="form-group">
                            <label>Ê™îÊ°àÊ®ôÁ±§</label>
                            <input type="text" id="label_${i}" placeholder="Ê™îÊ°à ${i + 1}" value="Ê™îÊ°à ${i + 1}">
                        </div>
                        <div class="form-group">
                            <label>Key Ê¨Ñ‰Ωç</label>
                            <select id="key_${i}">
                                <option value="">-- ÈÅ∏Êìá --</option>
                                ${filesData[i].columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="amount-section">
                            <div class="amount-toggle" onclick="toggleAmount(${i})">
                                <input type="checkbox" id="enableAmount_${i}" onclick="event.stopPropagation()">
                                <label style="cursor: pointer; font-weight: 600; margin: 0;">Êï∏ÂÄºÊ¨Ñ‰ΩçÊØîÂ∞ç</label>
                            </div>
                            <div class="amount-fields" id="amountFields_${i}">
                                <div class="form-group">
                                    <label>Êï∏ÂÄºÊ¨Ñ‰Ωç</label>
                                    <select id="amount_${i}">
                                        <option value="">-- ÈÅ∏Êìá --</option>
                                        ${filesData[i].columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ê¨Ñ‰ΩçË™™Êòé</label>
                                    <input type="text" id="amountLabel_${i}" placeholder="ÈÅ∏Â°´">
                                </div>
                                <div class="form-group">
                                    <label>ÂÆπÂ∑ÆÂÄº</label>
                                    <input type="number" id="tolerance_${i}" value="0.01" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleAmount(index) {
            const checkbox = document.getElementById(`enableAmount_${index}`);
            const fields = document.getElementById(`amountFields_${index}`);
            
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                fields.classList.add('show');
            } else {
                fields.classList.remove('show');
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            filesData.splice(index, 1);
            displayFiles();
            if (uploadedFiles.length < 2) {
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
            } else {
                updatePrimarySelector();
            }
        }

        function selectMode(radio) {
            document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
            radio.parentElement.classList.add('selected');
            
            const primarySelector = document.getElementById('primarySelector');
            if (radio.value === 'primary') {
                primarySelector.classList.add('show');
            } else {
                primarySelector.classList.remove('show');
            }
        }

        function updatePrimarySelector() {
            const select = document.getElementById('primaryFile');
            select.innerHTML = uploadedFiles.map((file, i) => {
                const label = document.getElementById(`label_${i}`)?.value || `Ê™îÊ°à ${i + 1}`;
                return `<option value="${i}">${label}</option>`;
            }).join('');
        }

        function performAnalysis() {
            // Áç≤ÂèñË®≠ÂÆö
            const config = [];
            for (let i = 0; i < uploadedFiles.length; i++) {
                const label = document.getElementById(`label_${i}`).value || `Ê™îÊ°à ${i + 1}`;
                const key = document.getElementById(`key_${i}`).value;
                
                if (!key) {
                    alert(`Ë´ãÁÇ∫„Äå${label}„ÄçÈÅ∏Êìá Key Ê¨Ñ‰Ωç`);
                    return;
                }

                const enableAmount = document.getElementById(`enableAmount_${i}`).checked;
                const amount = enableAmount ? document.getElementById(`amount_${i}`).value : '';
                const amountLabel = document.getElementById(`amountLabel_${i}`).value || '';
                const tolerance = enableAmount ? parseFloat(document.getElementById(`tolerance_${i}`).value) : 0;

                config.push({ label, key, amount, amountLabel, tolerance });
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const primaryIndex = mode === 'primary' ? parseInt(document.getElementById('primaryFile').value) : null;

            // Êî∂ÈõÜÊâÄÊúâ Key
            const allKeysMap = new Map();
            filesData.forEach((fileData, fileIndex) => {
                fileData.data.forEach(row => {
                    const keyValue = String(row[config[fileIndex].key] || '').trim();
                    if (keyValue) {
                        if (!allKeysMap.has(keyValue)) {
                            allKeysMap.set(keyValue, []);
                        }
                        allKeysMap.get(keyValue).push(fileIndex);
                    }
                });
            });

            // Ê†πÊìöÊ®°ÂºèÁØ©ÈÅ∏
            let targetKeys = [];
            if (mode === 'union') {
                targetKeys = Array.from(allKeysMap.keys());
            } else if (mode === 'intersection') {
                allKeysMap.forEach((indices, key) => {
                    const uniqueIndices = [...new Set(indices)];
                    if (uniqueIndices.length === uploadedFiles.length) {
                        targetKeys.push(key);
                    }
                });
            } else if (mode === 'primary') {
                filesData[primaryIndex].data.forEach(row => {
                    const keyValue = String(row[config[primaryIndex].key] || '').trim();
                    if (keyValue && !targetKeys.includes(keyValue)) {
                        targetKeys.push(keyValue);
                    }
                });
            }

            // ÂàÜÊûêÊØèÂÄã Key
            const results = [];
            targetKeys.forEach(keyValue => {
                const rowData = filesData.map((fileData, i) => {
                    return fileData.data.find(r => String(r[config[i].key] || '').trim() === keyValue) || null;
                });

                const existCount = rowData.filter(r => r !== null).length;
                let category;

                if (existCount === filesData.length) {
                    // ÈÉΩÂ≠òÂú® - Ê™¢Êü•Êï∏ÂÄº
                    const hasAmountCompare = config.some(c => c.amount);
                    if (hasAmountCompare) {
                        let hasDiff = false;
                        for (let i = 0; i < config.length - 1; i++) {
                            for (let j = i + 1; j < config.length; j++) {
                                if (config[i].amount && config[j].amount && rowData[i] && rowData[j]) {
                                    const amt1 = parseFloat(rowData[i][config[i].amount]) || 0;
                                    const amt2 = parseFloat(rowData[j][config[j].amount]) || 0;
                                    const diff = Math.abs(amt1 - amt2);
                                    const maxTolerance = Math.max(config[i].tolerance, config[j].tolerance);
                                    if (diff > maxTolerance) {
                                        hasDiff = true;
                                        break;
                                    }
                                }
                            }
                            if (hasDiff) break;
                        }
                        category = hasDiff ? 'value_diff' : 'match';
                    } else {
                        category = 'match';
                    }
                } else if (existCount === 1) {
                    const onlyInIndex = rowData.findIndex(r => r !== null);
                    category = `only_${onlyInIndex}`;
                } else {
                    category = 'partial';
                }

                const amounts = config.map((cfg, i) => {
                    if (cfg.amount && rowData[i]) {
                        return parseFloat(rowData[i][cfg.amount]) || 0;
                    }
                    return null;
                });

                results.push({ keyValue, rowData, category, existCount, amounts });
            });

            analysisResults = { results, config, mode, primaryIndex };
            displayResults();
        }

        function displayResults() {
            const { results, config } = analysisResults;

            // Áµ±Ë®à
            const stats = {
                total: results.length,
                match: results.filter(r => r.category === 'match').length,
                value_diff: results.filter(r => r.category === 'value_diff').length,
                partial: results.filter(r => r.category === 'partial').length
            };

            uploadedFiles.forEach((_, i) => {
                stats[`only_${i}`] = results.filter(r => r.category === `only_${i}`).length;
            });

            // Áµ±Ë®àÂç°Áâá
            const statsGrid = document.getElementById('statsGrid');
            let statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Á∏ΩÁ≠ÜÊï∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #4ade80;">${stats.match}</div>
                    <div class="stat-label">ÂÆåÂÖ®Áõ∏Á¨¶</div>
                </div>
            `;

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    statsHtml += `
                        <div class="stat-card">
                            <div class="stat-number" style="color: #fb923c;">${count}</div>
                            <div class="stat-label">ÂÉÖ${config[i].label}</div>
                        </div>
                    `;
                }
            });

            if (stats.value_diff > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number" style="color: #fbbf24;">${stats.value_diff}</div>
                        <div class="stat-label">Êï∏ÂÄºÂ∑ÆÁï∞</div>
                    </div>
                `;
            }

            if (stats.partial > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number" style="color: #60a5fa;">${stats.partial}</div>
                        <div class="stat-label">ÈÉ®ÂàÜÁº∫Â§±</div>
                    </div>
                `;
            }

            statsGrid.innerHTML = statsHtml;

            // ÊëòË¶Å
            const summaryBox = document.getElementById('summaryBox');
            const matchRate = stats.total > 0 ? ((stats.match / stats.total) * 100).toFixed(1) : 0;
            
            let summaryHtml = `
                <div class="summary-item">
                    <span class="summary-label">Áõ∏Á¨¶Áéá</span>
                    <span class="summary-value">${matchRate}%</span>
                </div>
            `;

            uploadedFiles.forEach((file, i) => {
                const count = results.filter(r => r.rowData[i] !== null).length;
                const coverage = stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : 0;
                summaryHtml += `
                    <div class="summary-item">
                        <span class="summary-label">${config[i].label} Ë¶ÜËìãÁéá</span>
                        <span class="summary-value">${coverage}%</span>
                    </div>
                `;
            });

            summaryBox.innerHTML = summaryHtml;

            // ÂúñË°®
            drawCharts(stats, config, results);

            // ÂàÜÈ†Å
            generateTabs(stats, config);

            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function drawCharts(stats, config, results) {
            // ÂúìÈ§ÖÂúñ
            const ctx1 = document.getElementById('pieChart').getContext('2d');
            const labels = [];
            const data = [];
            const colors = [];

            if (stats.match > 0) {
                labels.push('ÂÆåÂÖ®Áõ∏Á¨¶');
                data.push(stats.match);
                colors.push('#4ade80');
            }

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    labels.push(`ÂÉÖ${config[i].label}`);
                    data.push(count);
                    colors.push(['#ef4444', '#fb923c', '#60a5fa', '#a78bfa'][i % 4]);
                }
            });

            if (stats.value_diff > 0) {
                labels.push('Êï∏ÂÄºÂ∑ÆÁï∞');
                data.push(stats.value_diff);
                colors.push('#fbbf24');
            }

            if (stats.partial > 0) {
                labels.push('ÈÉ®ÂàÜÁº∫Â§±');
                data.push(stats.partial);
                colors.push('#94a3b8');
            }

            new Chart(ctx1, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Èï∑Ê¢ùÂúñ
            const ctx2 = document.getElementById('barChart').getContext('2d');
            const coverage = uploadedFiles.map((_, i) => {
                const count = results.filter(r => r.rowData[i] !== null).length;
                return stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : 0;
            });

            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: config.map(c => c.label),
                    datasets: [{
                        label: 'Ë¶ÜËìãÁéá (%)',
                        data: coverage,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function generateTabs(stats, config) {
            const tabs = document.getElementById('tabs');
            
            let tabsHtml = `
                <button class="tab active" onclick="switchTab('all', event)">
                    ÂÖ®ÈÉ® <span class="tab-badge">${stats.total}</span>
                </button>
            `;

            if (stats.match > 0) {
                tabsHtml += `
                    <button class="tab" onclick="switchTab('match', event)">
                        ÂÆåÂÖ®Áõ∏Á¨¶ <span class="tab-badge">${stats.match}</span>
                    </button>
                `;
            }

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    tabsHtml += `
                        <button class="tab" onclick="switchTab('only_${i}', event)">
                            ÂÉÖ${config[i].label} <span class="tab-badge">${count}</span>
                        </button>
                    `;
                }
            });

            if (stats.value_diff > 0) {
                tabsHtml += `
                    <button class="tab" onclick="switchTab('value_diff', event)">
                        Êï∏ÂÄºÂ∑ÆÁï∞ <span class="tab-badge">${stats.value_diff}</span>
                    </button>
                `;
            }

            if (stats.partial > 0) {
                tabsHtml += `
                    <button class="tab" onclick="switchTab('partial', event)">
                        ÈÉ®ÂàÜÁº∫Â§± <span class="tab-badge">${stats.partial}</span>
                    </button>
                `;
            }

            tabs.innerHTML = tabsHtml;
            switchTab('all');
        }

        function switchTab(categoryId, event) {
            if (event) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                event.currentTarget.classList.add('active');
            }

            const { results, config } = analysisResults;
            const filtered = categoryId === 'all' ? results : results.filter(r => r.category === categoryId);

            const content = document.getElementById('tabContent');
            
            if (filtered.length === 0) {
                content.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">ÁÑ°Ë≥áÊñô</p>';
                return;
            }

            let tableHtml = '<table class="data-table"><thead><tr>';
            tableHtml += '<th>Key ÂÄº</th>';
            
            config.forEach(cfg => {
                tableHtml += `<th>${cfg.label}</th>`;
            });

            const hasAmount = config.some(c => c.amount);
            if (hasAmount) {
                config.forEach(cfg => {
                    if (cfg.amount) {
                        tableHtml += `<th>${cfg.amountLabel || cfg.amount}</th>`;
                    }
                });
            }

            tableHtml += '</tr></thead><tbody>';

            filtered.forEach(row => {
                const rowClass = row.category.startsWith('only_') ? 'highlight-warning' : '';
                tableHtml += `<tr class="${rowClass}">`;
                tableHtml += `<td><strong>${row.keyValue}</strong></td>`;
                
                row.rowData.forEach((data) => {
                    tableHtml += data ? `<td>‚úì</td>` : `<td style="color: #999;">‚úó</td>`;
                });

                if (hasAmount) {
                    row.amounts.forEach((amt, i) => {
                        if (config[i].amount) {
                            const value = amt !== null ? amt.toLocaleString() : '-';
                            tableHtml += `<td>${value}</td>`;
                        }
                    });
                }

                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            content.innerHTML = tableHtml;
        }

        function exportResults() {
            if (!analysisResults) return;

            const { results, config } = analysisResults;
            const wb = XLSX.utils.book_new();

            // ÊëòË¶Å
            const summary = [
                ['Ë≥áÊñôÊØîÂ∞çÂ†±Âëä'],
                ['Áî¢ÁîüÊôÇÈñì', new Date().toLocaleString('zh-TW')],
                [''],
                ['Ê™îÊ°àË≥áË®ä']
            ];

            config.forEach((cfg, i) => {
                summary.push([`Ê™îÊ°à ${i + 1}`, cfg.label, uploadedFiles[i].name]);
            });

            summary.push([''], ['Áµ±Ë®à'], ['Á∏ΩÁ≠ÜÊï∏', results.length]);

            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'ÊëòË¶Å');

            // Ë©≥Á¥∞Ë≥áÊñô
            const detailData = results.map(row => {
                const obj = { 'Key': row.keyValue };
                config.forEach((cfg, i) => {
                    obj[cfg.label] = row.rowData[i] ? '‚úì' : '‚úó';
                });
                config.forEach((cfg, i) => {
                    if (cfg.amount && row.amounts[i] !== null) {
                        obj[`${cfg.label}_${cfg.amountLabel || cfg.amount}`] = row.amounts[i];
                    }
                });
                return obj;
            });

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detailData), 'Ë©≥Á¥∞Ë≥áÊñô');

            XLSX.writeFile(wb, `ÊØîÂ∞çÂ†±Âëä_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
    </script>
</body>
</html>