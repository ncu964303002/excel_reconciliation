<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Excel è³‡æ–™æ¯”å°å·¥å…· - å°ˆæ¥­çš„å¤šæª”æ¡ˆè³‡æ–™å‹¾ç¨½æ¯”å°ç³»çµ±">
    <title>Excel è³‡æ–™æ¯”å°å·¥å…·</title>
    
    <!-- ä½¿ç”¨ CDN ä½†åŠ å…¥å‚™æ´æ©Ÿåˆ¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" 
            onerror="alert('ç„¡æ³•è¼‰å…¥ Excel è™•ç†å‡½å¼åº«ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š')"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" 
            onerror="console.warn('åœ–è¡¨å‡½å¼åº«è¼‰å…¥å¤±æ•—ï¼Œåœ–è¡¨åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨')"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .file-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }

        .file-stats {
            font-size: 12px;
            color: #666;
        }

        .file-config {
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .key-selector {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .key-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .key-item:hover {
            background: #e3f2fd;
        }

        .key-item input[type="checkbox"] {
            cursor: pointer;
        }

        .key-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-weight: normal;
        }

        .helper-text {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .comparison-mode {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .mode-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .mode-options {
            display: grid;
            gap: 10px;
        }

        .mode-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-option input[type="radio"] {
            cursor: pointer;
        }

        .mode-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .mode-desc {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .primary-selector {
            margin-top: 15px;
            display: none;
        }

        .primary-selector.show {
            display: block;
        }

        .primary-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .columns-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .columns-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .columns-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .select-all-btns {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-select-all {
            background: #28a745;
            color: white;
        }

        .btn-deselect-all {
            background: #6c757d;
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .file-columns-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-columns-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .file-columns-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .column-item:hover {
            background: #e3f2fd;
        }

        .column-item input[type="checkbox"] {
            cursor: pointer;
        }

        .column-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-size: 13px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
        }

        .btn-clear {
            background: #ffc107;
            color: #333;
            width: 100%;
            padding: 16px;
            font-size: 16px;
            margin-top: 15px;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-export {
            background: #28a745;
            color: white;
        }

        .conclusion-report {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .report-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .summary-box {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            opacity: 0.9;
        }

        .summary-value {
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 18px;
            border: none;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .highlight-warning {
            background: #fff3cd !important;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 968px) {
            .columns-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excel è³‡æ–™æ¯”å°å·¥å…·</h1>
            <p>å°ˆæ¥­çš„å¤šæª”æ¡ˆè³‡æ–™å‹¾ç¨½æ¯”å°ç³»çµ±</p>
        </div>

        <div class="content">
            <!-- ä¸Šå‚³æª”æ¡ˆ -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">1</span>
                    ä¸Šå‚³æª”æ¡ˆ
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•</h3>
                    <p style="color: #666; margin-top: 10px;">æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼</p>
                    <input type="file" id="fileInput" style="display: none;" accept=".xlsx,.xls" multiple>
                </div>
                <div id="uploadedFiles" style="margin-top: 20px;"></div>
            </div>

            <!-- æ¯”å°è¨­å®š -->
            <div class="section" id="configSection" style="display: none;">
                <div class="section-title">
                    <span class="step-number">2</span>
                    æ¯”å°è¨­å®š
                </div>
                
                <div class="comparison-mode">
                    <div class="mode-title">æ¯”å°æ¨¡å¼</div>
                    <div class="mode-options">
                        <label class="mode-option selected">
                            <input type="radio" name="mode" value="union" checked onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">è¯é›†</div>
                                <div class="mode-desc">é¡¯ç¤ºæ‰€æœ‰æª”æ¡ˆä¸­å‡ºç¾çš„ Key</div>
                            </div>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="intersection" onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">äº¤é›†</div>
                                <div class="mode-desc">åƒ…é¡¯ç¤ºæ‰€æœ‰æª”æ¡ˆå…±åŒçš„ Key</div>
                            </div>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="primary" onchange="selectMode(this)">
                            <div>
                                <div class="mode-label">æŒ‡å®šä¸»æª”</div>
                                <div class="mode-desc">ä»¥æŸä¸€æª”æ¡ˆç‚ºåŸºæº–é€²è¡Œæ¯”å°</div>
                            </div>
                        </label>
                    </div>
                    <div class="primary-selector" id="primarySelector">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">ä¸»è¦æª”æ¡ˆ</label>
                        <select id="primaryFile"></select>
                    </div>
                </div>
            </div>

            <!-- ç”¢å‡ºæ¬„ä½é¸æ“‡ -->
            <div class="section" id="outputSection" style="display: none;">
                <div class="section-title">
                    <span class="step-number">3</span>
                    ç”¢å‡ºæ–° Excel çš„æ¬„ä½
                </div>
                
                <div class="columns-section">
                    <div class="columns-header">
                        <h3>é¸æ“‡è¦åŒ…å«åœ¨çµæœä¸­çš„æ¬„ä½</h3>
                        <div class="select-all-btns">
                            <button class="btn-small btn-select-all" onclick="selectAllColumns()">å…¨é¸</button>
                            <button class="btn-small btn-deselect-all" onclick="deselectAllColumns()">å–æ¶ˆå…¨é¸</button>
                        </div>
                    </div>
                    <div id="columnsContainer"></div>
                </div>

                <button class="btn btn-primary" onclick="performAnalysis()">
                    é–‹å§‹æ¯”å°
                </button>

                <button class="btn btn-clear" onclick="clearAll()">
                    ğŸ”„ æ¸…é™¤ï¼Œæ¯”è¼ƒä¸‹ä¸€ç­†
                </button>
            </div>

            <!-- çµæœ -->
            <div id="resultSection" style="display: none;">
                <div class="conclusion-report">
                    <div class="report-title">æ¯”å°çµæœ</div>
                    
                    <div class="stats-grid" id="statsGrid"></div>

                    <div class="summary-box" id="summaryBox"></div>
                </div>

                <!-- åœ–è¡¨ -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">è³‡æ–™åˆ†å¸ƒ</div>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">æª”æ¡ˆè¦†è“‹ç‡</div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- è©³ç´°è³‡æ–™ -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="section-title" style="margin: 0;">
                            è©³ç´°è³‡æ–™
                        </div>
                        <button class="btn btn-export" onclick="exportResults()">
                            åŒ¯å‡º Excel
                        </button>
                    </div>
                    
                    <div class="tabs" id="tabs"></div>
                    <div id="tabContent" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            Excel è³‡æ–™æ¯”å°å·¥å…· v1.0 | æ‰€æœ‰è³‡æ–™è™•ç†å‡åœ¨æœ¬åœ°ç€è¦½å™¨é€²è¡Œï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let uploadedFiles = [];
        let filesData = [];
        let analysisResults = null;
        let chartInstances = [];

        // ä¸Šå‚³è™•ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.onclick = () => fileInput.click();
        uploadArea.ondragover = (e) => { e.preventDefault(); uploadArea.style.background = '#f0f4ff'; };
        uploadArea.ondragleave = () => { uploadArea.style.background = 'white'; };
        uploadArea.ondrop = (e) => {
            e.preventDefault();
            uploadArea.style.background = 'white';
            handleFiles(e.dataTransfer.files);
        };
        fileInput.onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) {
            for (let file of files) {
                if (file.name.match(/\.(xlsx|xls)$/)) {
                    try {
                        const data = await readExcel(file);
                        uploadedFiles.push(file);
                        filesData.push(data);
                    } catch (error) {
                        console.error('è®€å–æª”æ¡ˆå¤±æ•—:', error);
                        alert(`è®€å–æª”æ¡ˆ ${file.name} å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º`);
                    }
                }
            }
            displayFiles();
            if (uploadedFiles.length >= 2) {
                document.getElementById('configSection').style.display = 'block';
                document.getElementById('outputSection').style.display = 'block';
                updatePrimarySelector();
                displayColumnsSelector();
            }
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws);
                        const columns = data.length > 0 ? Object.keys(data[0]) : [];
                        resolve({ data, columns, sheetName: wb.SheetNames[0] });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function displayFiles() {
            const container = document.getElementById('uploadedFiles');
            
            container.innerHTML = uploadedFiles.map((file, i) => `
                <div class="file-item">
                    <div class="file-header">
                        <div class="file-info">
                            <div class="file-name">ğŸ“„ ${file.name}</div>
                            <div class="file-stats">${filesData[i].data.length} ç­† | ${filesData[i].columns.length} æ¬„ä½</div>
                        </div>
                        <button class="btn btn-remove" onclick="removeFile(${i})">ç§»é™¤</button>
                    </div>

                    <div class="file-config">
                        <div class="form-group">
                            <label>æª”æ¡ˆæ¨™ç±¤</label>
                            <input type="text" id="label_${i}" placeholder="æª”æ¡ˆ ${i + 1}" value="æª”æ¡ˆ ${i + 1}">
                            <div class="helper-text">ç”¨æ–¼è­˜åˆ¥æª”æ¡ˆçš„è‡ªè¨‚åç¨±</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Key æ¬„ä½ï¼ˆå¯è¤‡é¸ï¼‰</label>
                            <div class="key-selector" id="keySelector_${i}">
                                ${filesData[i].columns.map(col => `
                                    <div class="key-item" onclick="toggleKeyCheckbox(${i}, '${col.replace(/'/g, "\\'")}')">
                                        <input type="checkbox" id="key_${i}_${col}" value="${col}" onclick="event.stopPropagation()">
                                        <label for="key_${i}_${col}">${col}</label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="helper-text">é¸æ“‡ç”¨æ–¼æ¯”å°çš„é—œéµæ¬„ä½ï¼Œå¯é¸æ“‡å¤šå€‹æ¬„ä½çµ„æˆè¤‡åˆ Key</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleKeyCheckbox(fileIndex, colName) {
            const checkbox = document.getElementById(`key_${fileIndex}_${colName}`);
            checkbox.checked = !checkbox.checked;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            filesData.splice(index, 1);
            displayFiles();
            if (uploadedFiles.length < 2) {
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('outputSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
            } else {
                updatePrimarySelector();
                displayColumnsSelector();
            }
        }

        function selectMode(radio) {
            document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
            radio.parentElement.classList.add('selected');
            
            const primarySelector = document.getElementById('primarySelector');
            if (radio.value === 'primary') {
                primarySelector.classList.add('show');
            } else {
                primarySelector.classList.remove('show');
            }
        }

        function updatePrimarySelector() {
            const select = document.getElementById('primaryFile');
            select.innerHTML = uploadedFiles.map((file, i) => {
                const label = document.getElementById(`label_${i}`)?.value || `æª”æ¡ˆ ${i + 1}`;
                return `<option value="${i}">${label}</option>`;
            }).join('');
        }

        function displayColumnsSelector() {
            const container = document.getElementById('columnsContainer');
            
            let html = '';
            uploadedFiles.forEach((file, fileIndex) => {
                const label = document.getElementById(`label_${fileIndex}`)?.value || `æª”æ¡ˆ ${fileIndex + 1}`;
                
                html += `
                    <div class="file-columns-group">
                        <div class="file-columns-title">${label} - ${file.name}</div>
                        <div class="columns-grid">
                            ${filesData[fileIndex].columns.map(col => `
                                <div class="column-item" onclick="toggleColumnCheckbox(${fileIndex}, '${col.replace(/'/g, "\\'")}')">
                                    <input type="checkbox" id="col_${fileIndex}_${col}" value="${col}" checked onclick="event.stopPropagation()">
                                    <label for="col_${fileIndex}_${col}">${col}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleColumnCheckbox(fileIndex, colName) {
            const checkbox = document.getElementById(`col_${fileIndex}_${colName}`);
            checkbox.checked = !checkbox.checked;
        }

        function selectAllColumns() {
            document.querySelectorAll('#columnsContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllColumns() {
            document.querySelectorAll('#columnsContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
                uploadedFiles = [];
                filesData = [];
                analysisResults = null;
                
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
                
                document.getElementById('uploadedFiles').innerHTML = '';
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('outputSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                
                fileInput.value = '';
            }
        }

        function performAnalysis() {
            const config = [];
            for (let i = 0; i < uploadedFiles.length; i++) {
                const label = document.getElementById(`label_${i}`).value || `æª”æ¡ˆ ${i + 1}`;
                
                const keys = [];
                filesData[i].columns.forEach(col => {
                    const checkbox = document.getElementById(`key_${i}_${col}`);
                    if (checkbox && checkbox.checked) {
                        keys.push(col);
                    }
                });
                
                if (keys.length === 0) {
                    alert(`è«‹ç‚ºã€Œ${label}ã€è‡³å°‘é¸æ“‡ä¸€å€‹ Key æ¬„ä½`);
                    return;
                }

                const outputColumns = [];
                filesData[i].columns.forEach(col => {
                    const checkbox = document.getElementById(`col_${i}_${col}`);
                    if (checkbox && checkbox.checked) {
                        outputColumns.push(col);
                    }
                });

                config.push({ label, keys, outputColumns });
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const primaryIndex = mode === 'primary' ? parseInt(document.getElementById('primaryFile').value) : null;

            const allKeysMap = new Map();
            filesData.forEach((fileData, fileIndex) => {
                fileData.data.forEach(row => {
                    const keyValues = config[fileIndex].keys.map(k => String(row[k] || '').trim());
                    const compositeKey = keyValues.join('|');
                    
                    if (compositeKey && !keyValues.every(v => v === '')) {
                        if (!allKeysMap.has(compositeKey)) {
                            allKeysMap.set(compositeKey, { keyValues, fileIndices: [] });
                        }
                        allKeysMap.get(compositeKey).fileIndices.push(fileIndex);
                    }
                });
            });

            let targetKeys = [];
            if (mode === 'union') {
                targetKeys = Array.from(allKeysMap.keys());
            } else if (mode === 'intersection') {
                allKeysMap.forEach((value, key) => {
                    const uniqueIndices = [...new Set(value.fileIndices)];
                    if (uniqueIndices.length === uploadedFiles.length) {
                        targetKeys.push(key);
                    }
                });
            } else if (mode === 'primary') {
                filesData[primaryIndex].data.forEach(row => {
                    const keyValues = config[primaryIndex].keys.map(k => String(row[k] || '').trim());
                    const compositeKey = keyValues.join('|');
                    if (compositeKey && !keyValues.every(v => v === '') && !targetKeys.includes(compositeKey)) {
                        targetKeys.push(compositeKey);
                    }
                });
            }

            const results = [];
            targetKeys.forEach(compositeKey => {
                const keyInfo = allKeysMap.get(compositeKey);
                
                const rowData = filesData.map((fileData, i) => {
                    return fileData.data.find(r => {
                        const keyValues = config[i].keys.map(k => String(r[k] || '').trim());
                        return keyValues.join('|') === compositeKey;
                    }) || null;
                });

                const existCount = rowData.filter(r => r !== null).length;
                let category;

                if (existCount === filesData.length) {
                    category = 'match';
                } else if (existCount === 1) {
                    const onlyInIndex = rowData.findIndex(r => r !== null);
                    category = `only_${onlyInIndex}`;
                } else {
                    category = 'partial';
                }

                results.push({ 
                    compositeKey, 
                    keyValues: keyInfo.keyValues,
                    rowData, 
                    category, 
                    existCount 
                });
            });

            analysisResults = { results, config, mode, primaryIndex };
            displayResults();
        }

        function displayResults() {
            const { results, config } = analysisResults;

            const stats = {
                total: results.length,
                match: results.filter(r => r.category === 'match').length,
                partial: results.filter(r => r.category === 'partial').length
            };

            uploadedFiles.forEach((_, i) => {
                stats[`only_${i}`] = results.filter(r => r.category === `only_${i}`).length;
            });

            const statsGrid = document.getElementById('statsGrid');
            let statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">ç¸½ç­†æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #4ade80;">${stats.match}</div>
                    <div class="stat-label">å®Œå…¨ç›¸ç¬¦</div>
                </div>
            `;

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    statsHtml += `
                        <div class="stat-card">
                            <div class="stat-number" style="color: #fb923c;">${count}</div>
                            <div class="stat-label">åƒ…${config[i].label}</div>
                        </div>
                    `;
                }
            });

            if (stats.partial > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number" style="color: #60a5fa;">${stats.partial}</div>
                        <div class="stat-label">éƒ¨åˆ†ç¼ºå¤±</div>
                    </div>
                `;
            }

            statsGrid.innerHTML = statsHtml;

            const summaryBox = document.getElementById('summaryBox');
            const matchRate = stats.total > 0 ? ((stats.match / stats.total) * 100).toFixed(1) : 0;
            
            let summaryHtml = `
                <div class="summary-item">
                    <span class="summary-label">ç›¸ç¬¦ç‡</span>
                    <span class="summary-value">${matchRate}%</span>
                </div>
            `;

            uploadedFiles.forEach((file, i) => {
                const count = results.filter(r => r.rowData[i] !== null).length;
                const coverage = stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : 0;
                summaryHtml += `
                    <div class="summary-item">
                        <span class="summary-label">${config[i].label} è¦†è“‹ç‡</span>
                        <span class="summary-value">${coverage}%</span>
                    </div>
                `;
            });

            summaryBox.innerHTML = summaryHtml;

            drawCharts(stats, config, results);
            generateTabs(stats, config);

            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function drawCharts(stats, config, results) {
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js æœªè¼‰å…¥ï¼Œè·³éåœ–è¡¨ç¹ªè£½');
                return;
            }

            const ctx1 = document.getElementById('pieChart').getContext('2d');
            const labels = [];
            const data = [];
            const colors = [];

            if (stats.match > 0) {
                labels.push('å®Œå…¨ç›¸ç¬¦');
                data.push(stats.match);
                colors.push('#4ade80');
            }

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    labels.push(`åƒ…${config[i].label}`);
                    data.push(count);
                    colors.push(['#ef4444', '#fb923c', '#60a5fa', '#a78bfa'][i % 4]);
                }
            });

            if (stats.partial > 0) {
                labels.push('éƒ¨åˆ†ç¼ºå¤±');
                data.push(stats.partial);
                colors.push('#94a3b8');
            }

            const pieChart = new Chart(ctx1, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true }
            });
            chartInstances.push(pieChart);

            const ctx2 = document.getElementById('barChart').getContext('2d');
            const coverage = uploadedFiles.map((_, i) => {
                const count = results.filter(r => r.rowData[i] !== null).length;
                return stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : 0;
            });

            const barChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: config.map(c => c.label),
                    datasets: [{
                        label: 'è¦†è“‹ç‡ (%)',
                        data: coverage,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
            chartInstances.push(barChart);
        }

        function generateTabs(stats, config) {
            const tabs = document.getElementById('tabs');
            
            let tabsHtml = `
                <button class="tab active" onclick="switchTab('all', event)">
                    å…¨éƒ¨ <span class="tab-badge">${stats.total}</span>
                </button>
            `;

            if (stats.match > 0) {
                tabsHtml += `
                    <button class="tab" onclick="switchTab('match', event)">
                        å®Œå…¨ç›¸ç¬¦ <span class="tab-badge">${stats.match}</span>
                    </button>
                `;
            }

            uploadedFiles.forEach((_, i) => {
                const count = stats[`only_${i}`] || 0;
                if (count > 0) {
                    tabsHtml += `
                        <button class="tab" onclick="switchTab('only_${i}', event)">
                            åƒ…${config[i].label} <span class="tab-badge">${count}</span>
                        </button>
                    `;
                }
            });

            if (stats.partial > 0) {
                tabsHtml += `
                    <button class="tab" onclick="switchTab('partial', event)">
                        éƒ¨åˆ†ç¼ºå¤± <span class="tab-badge">${stats.partial}</span>
                    </button>
                `;
            }

            tabs.innerHTML = tabsHtml;
            switchTab('all');
        }

        function switchTab(categoryId, event) {
            if (event) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                event.currentTarget.classList.add('active');
            }

            const { results, config } = analysisResults;
            const filtered = categoryId === 'all' ? results : results.filter(r => r.category === categoryId);

            const content = document.getElementById('tabContent');
            
            if (filtered.length === 0) {
                content.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">ç„¡è³‡æ–™</p>';
                return;
            }

            let tableHtml = '<table class="data-table"><thead><tr>';
            
            const maxKeyCount = Math.max(...config.map(c => c.keys.length));
            for (let i = 0; i < maxKeyCount; i++) {
                tableHtml += `<th>Key ${i + 1}</th>`;
            }
            
            config.forEach((cfg, fileIndex) => {
                cfg.outputColumns.forEach(col => {
                    tableHtml += `<th>${cfg.label}_${col}</th>`;
                });
            });

            tableHtml += '</tr></thead><tbody>';

            filtered.forEach(row => {
                const rowClass = row.category.startsWith('only_') ? 'highlight-warning' : '';
                tableHtml += `<tr class="${rowClass}">`;
                
                for (let i = 0; i < maxKeyCount; i++) {
                    const keyValue = row.keyValues[i] || '-';
                    tableHtml += `<td><strong>${keyValue}</strong></td>`;
                }
                
                config.forEach((cfg, fileIndex) => {
                    cfg.outputColumns.forEach(col => {
                        const data = row.rowData[fileIndex];
                        const value = data && data[col] !== undefined ? data[col] : '-';
                        tableHtml += `<td>${value}</td>`;
                    });
                });

                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            content.innerHTML = tableHtml;
        }

        function exportResults() {
            if (!analysisResults) return;

            const { results, config } = analysisResults;
            const wb = XLSX.utils.book_new();

            const summary = [
                ['è³‡æ–™æ¯”å°å ±å‘Š'],
                ['ç”¢ç”Ÿæ™‚é–“', new Date().toLocaleString('zh-TW')],
                [''],
                ['æª”æ¡ˆè³‡è¨Š']
            ];

            config.forEach((cfg, i) => {
                summary.push([`æª”æ¡ˆ ${i + 1}`, cfg.label, uploadedFiles[i].name]);
                summary.push(['Key æ¬„ä½', cfg.keys.join(', ')]);
            });

            summary.push([''], ['çµ±è¨ˆ'], ['ç¸½ç­†æ•¸', results.length]);

            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'æ‘˜è¦');

            const detailData = results.map(row => {
                const obj = {};
                
                row.keyValues.forEach((keyVal, i) => {
                    obj[`Key_${i + 1}`] = keyVal;
                });
                
                config.forEach((cfg, fileIndex) => {
                    cfg.outputColumns.forEach(col => {
                        const data = row.rowData[fileIndex];
                        obj[`${cfg.label}_${col}`] = data && data[col] !== undefined ? data[col] : '';
                    });
                });
                
                return obj;
            });

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detailData), 'è©³ç´°è³‡æ–™');

            XLSX.writeFile(wb, `æ¯”å°å ±å‘Š_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
    </script>
</body>
</html>