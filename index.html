<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Excel è³‡æ–™æ¯”å°å·¥å…· - å°ˆæ¥­çš„å¤šæª”æ¡ˆè³‡æ–™å‹¾ç¨½æ¯”å°ç³»çµ±">
<title>Excel è³‡æ–™æ¯”å°å·¥å…·</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Microsoft JhengHei',sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
.container { max-width:1600px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
.header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:30px; text-align:center; border-radius:15px 15px 0 0; }
.header h1 { font-size:28px; margin-bottom:10px; }
.content { padding:30px; }
.section { background:#f8f9fa; border-radius:10px; padding:25px; margin-bottom:25px; }
.section-title { font-size:18px; font-weight:600; color:#333; margin-bottom:20px; display:flex; align-items:center; gap:10px; }
.step-number { background:#667eea; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; }
.upload-area { border:2px dashed #667eea; border-radius:10px; padding:40px; text-align:center; background:white; cursor:pointer; transition:all 0.3s; }
.upload-area:hover { background:#f0f4ff; border-color:#764ba2; }
.upload-hint { background:#fff3cd; border:1px solid #ffc107; border-radius:8px; padding:12px 20px; margin-top:15px; text-align:left; font-size:14px; color:#856404; }
.file-item { background:white; border:2px solid #e0e0e0; border-radius:10px; padding:20px; margin-bottom:15px; }
.file-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px; }
.file-name { font-weight:600; font-size:15px; color:#333; margin-bottom:5px; }
.file-stats { font-size:12px; color:#666; }
.file-config { padding-top:15px; border-top:1px solid #e0e0e0; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; font-size:13px; font-weight:600; color:#555; margin-bottom:8px; }
.form-group input, .form-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; }
.key-selector { background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:12px; max-height:200px; overflow-y:auto; }
.key-item { display:flex; align-items:center; gap:6px; padding:5px 8px; margin-bottom:2px; background:white; border-radius:4px; cursor:pointer; user-select:none; }
.key-item:hover { background:#e3f2fd; }
.key-item input[type="checkbox"] { margin:0; flex-shrink:0; width:16px; height:16px; }
.key-item label { margin:0; cursor:pointer; flex:1; text-align:left; font-size:14px; line-height:1.4; padding-left:2px; }
.key-validation { margin-top:10px; padding:10px; border-radius:6px; font-size:13px; }
.key-validation.success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
.key-validation.error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
.key-display { margin-top:10px; padding:10px; background:#e3f2fd; border:1px solid #2196f3; border-radius:6px; font-size:13px; color:#1565c0; }
.helper-text { font-size:11px; color:#999; margin-top:5px; }
.mode-option { background:#f8f9fa; border:2px solid #e0e0e0; border-radius:8px; padding:12px 15px; cursor:pointer; display:flex; gap:10px; margin-bottom:10px; }
.mode-option.selected { border-color:#667eea; background:#f0f4ff; }
.columns-section { background:white; border-radius:8px; padding:20px; margin-top:20px; }
.columns-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:8px; }
.column-item { display:flex; align-items:center; gap:8px; padding:8px; background:#f8f9fa; border-radius:4px; cursor:pointer; }
.column-item.is-key { opacity:0.5; cursor:not-allowed; }
.file-columns-group { margin-bottom:20px; padding:20px; background:#f8f9fa; border-radius:8px; }
.file-columns-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
.file-columns-title { font-weight:600; color:#667eea; font-size:14px; }
.btn { padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; transition:all 0.3s; }
.btn:hover { transform:translateY(-2px); }
.btn-primary { background:#667eea; color:white; width:100%; padding:16px; font-size:16px; min-height:54px; }
.btn-clear { background:#ffc107; color:#333; width:100%; padding:16px; margin-top:15px; min-height:54px; }
.btn-remove { background:#dc3545; color:white; padding:8px 16px; font-size:13px; }
.btn-export { background:#28a745; color:white; }
.btn-small { padding:6px 12px; font-size:12px; }
.data-table { width:100%; border-collapse:collapse; font-size:13px; }
.data-table th, .data-table td { padding:12px; border:1px solid #e0e0e0; text-align:left; }
.data-table th { background:#f8f9fa; font-weight:600; }
.data-table tr { transition:background 0.2s; }
.footer { text-align:center; padding:20px; color:#666; font-size:12px; border-top:1px solid #e0e0e0; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ“Š Excel è³‡æ–™æ¯”å°å·¥å…·</h1>
<p>å°ˆæ¥­çš„å¤šæª”æ¡ˆè³‡æ–™å‹¾ç¨½æ¯”å°ç³»çµ±</p>
</div>
<div class="content">
<div class="section">
<div class="section-title"><span class="step-number">1</span>ä¸Šå‚³æª”æ¡ˆ</div>
<div class="upload-area" id="uploadArea">
<div style="font-size:48px;color:#667eea;margin-bottom:15px;">ğŸ“</div>
<h3>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•</h3>
<p style="color:#666;margin-top:10px;">æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼</p>
</div>
<div class="upload-hint"><strong>ğŸ’¡ å‹å–„æé†’ï¼š</strong>ä¸»è¦æª”æ¡ˆè«‹ç¬¬ä¸€é †ä½ä¸Šå‚³ï¼Œæœ‰åŠ©æ–¼å¾ŒçºŒè¨­å®šå’Œæ¯”å°ã€‚</div>
<div id="uploadedFiles" style="margin-top:20px;"></div>
</div>
<div class="section" id="configSection" style="display:none;">
<div class="section-title"><span class="step-number">2</span>æ¯”å°è¨­å®š</div>
<div style="background:white;border-radius:8px;padding:20px;">
<div style="font-size:14px;font-weight:600;margin-bottom:15px;">æ¯”å°æ¨¡å¼</div>
<label class="mode-option selected"><input type="radio" name="mode" value="union" checked onchange="selectMode(this)"><div><div>è¯é›†</div><div style="font-size:12px;color:#666;">é¡¯ç¤ºæ‰€æœ‰æª”æ¡ˆä¸­å‡ºç¾çš„ Key</div></div></label>
<label class="mode-option"><input type="radio" name="mode" value="intersection" onchange="selectMode(this)"><div><div>äº¤é›†</div><div style="font-size:12px;color:#666;">åƒ…é¡¯ç¤ºæ‰€æœ‰æª”æ¡ˆå…±åŒçš„ Key</div></div></label>
<label class="mode-option"><input type="radio" name="mode" value="primary" onchange="selectMode(this)"><div><div>æŒ‡å®šä¸»æª”</div><div style="font-size:12px;color:#666;">ä»¥æŸä¸€æª”æ¡ˆç‚ºåŸºæº–é€²è¡Œæ¯”å°</div></div></label>
<div id="primarySelector" style="margin-top:15px;display:none;"><label style="font-weight:600;font-size:13px;">è«‹é¸æ“‡ä¸»æª”æ¡ˆï¼ˆKey æ¬„ä½åç¨±ä»¥æ­¤ç‚ºä¸»ï¼‰</label><select id="primaryFile" style="width:100%;padding:10px;margin-top:8px;"></select></div>
</div>
</div>
<div class="section" id="outputSection" style="display:none;">
<div class="section-title"><span class="step-number">3</span>ç”¢å‡ºæ–° Excel çš„æ¬„ä½</div>
<div class="columns-section">
<div style="font-size:14px;font-weight:600;margin-bottom:15px;">é¸æ“‡è¦åŒ…å«åœ¨çµæœä¸­çš„æ¬„ä½</div>
<div id="columnsContainer"></div>
</div>
<button class="btn btn-primary" onclick="performAnalysis()">é–‹å§‹æ¯”å°</button>
<button class="btn btn-clear" onclick="clearAll()">ğŸ”„ æ¸…é™¤ï¼Œæ¯”è¼ƒä¸‹ä¸€ç­†</button>
</div>
<div id="resultSection" style="display:none;">
<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:12px;padding:30px;margin-bottom:30px;">
<div style="font-size:22px;font-weight:700;margin-bottom:20px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.3);padding-bottom:15px;">æ¯”å°çµæœ</div>
<div id="statsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px;"></div>
<div id="summaryBox" style="background:rgba(255,255,255,0.15);border-radius:10px;padding:20px;"></div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:30px;">
<div style="background:white;border-radius:10px;padding:20px;"><div style="font-size:16px;font-weight:600;text-align:center;margin-bottom:15px;">è³‡æ–™åˆ†å¸ƒ</div><canvas id="pieChart"></canvas></div>
<div style="background:white;border-radius:10px;padding:20px;"><div style="font-size:16px;font-weight:600;text-align:center;margin-bottom:15px;">æª”æ¡ˆè¦†è“‹ç‡</div><canvas id="barChart"></canvas></div>
</div>
<div class="section">
<div style="display:flex;justify-content:space-between;margin-bottom:20px;">
<div class="section-title" style="margin:0;">è©³ç´°è³‡æ–™</div>
<button class="btn btn-export" onclick="exportResults()">åŒ¯å‡º Excel</button>
</div>
<div id="tabs" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;"></div>
<div id="tabContent" style="max-height:500px;overflow-y:auto;"></div>
</div>
</div>
</div>
<div class="footer">Excel è³‡æ–™æ¯”å°å·¥å…· v1.0 | æ‰€æœ‰è³‡æ–™è™•ç†å‡åœ¨æœ¬åœ°ç€è¦½å™¨é€²è¡Œï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨</div>
</div>

<script>
// ä½ çš„å®Œæ•´ JS ç¨‹å¼ç¢¼ï¼ˆå·²æ•´åˆå„ªåŒ–ï¼‰
let uploadedFiles=[],filesData=[],analysisResults=null,chartInstances=[];
const uploadArea=document.getElementById('uploadArea'),fileInput=document.createElement('input');
fileInput.type='file';fileInput.accept='.xlsx,.xls';fileInput.multiple=true;fileInput.style.display='none';document.body.appendChild(fileInput);
uploadArea.onclick=()=>fileInput.click();
uploadArea.ondragover=e=>{e.preventDefault();uploadArea.style.background='#f0f4ff';};
uploadArea.ondragleave=()=>{uploadArea.style.background='white';};
uploadArea.ondrop=e=>{e.preventDefault();uploadArea.style.background='white';handleFiles(e.dataTransfer.files);};
fileInput.onchange=e=>handleFiles(e.target.files);

async function handleFiles(files){
for(let file of files){
if(file.name.match(/\.(xlsx|xls)$/)){
if(file.size>50*1024*1024){alert(`${file.name} è¶…é50MBï¼Œå»ºè­°åˆ†å‰²`);continue;}
try{const allSheets=await readExcelAllSheets(file);uploadedFiles.push(file);filesData.push(allSheets);}catch(error){alert(`è®€å– ${file.name} å¤±æ•—`);}}
}
displayFiles();
if(uploadedFiles.length>=2){document.getElementById('configSection').style.display='block';document.getElementById('outputSection').style.display='block';updatePrimarySelector();displayColumnsSelector();}
}

function readExcelAllSheets(file){
return new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.onload=e=>{
try{
const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
const allSheets=wb.SheetNames.map(sheetName=>{
const ws=wb.Sheets[sheetName];
const data=XLSX.utils.sheet_to_json(ws);
const columns=data.length>0?Object.keys(data[0]):[];
return{sheetName,data,columns};
});
resolve({fileName:file.name,sheets:allSheets,selectedSheetIndex:0});
}catch(error){reject(error);}};
reader.onerror=reject;
reader.readAsArrayBuffer(file);
});
}

function displayFiles(){
const container=document.getElementById('uploadedFiles');
container.innerHTML=uploadedFiles.map((file,i)=>{
const fileData=filesData[i];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
const fileLabel=`${fileData.fileName.replace(/\.(xlsx|xls)$/i,'')}_${selectedSheet.sheetName}`;
return`<div class="file-item"><div class="file-header"><div style="flex:1;"><div class="file-name">ğŸ“„ ${file.name}</div><div class="file-stats">${selectedSheet.data.length} ç­† | ${selectedSheet.columns.length} æ¬„ä½</div></div><button class="btn btn-remove" onclick="removeFile(${i})">ç§»é™¤</button></div><div class="file-config">${fileData.sheets.length>1?`<div class="form-group"><label>é¸æ“‡å·¥ä½œè¡¨</label><select id="sheet_${i}" onchange="changeSheet(${i},this.value)">${fileData.sheets.map((s,idx)=>`<option value="${idx}" ${idx===fileData.selectedSheetIndex?'selected':''}>${s.sheetName} (${s.data.length} ç­†)</option>`).join('')}</select><div class="helper-text">æ­¤æª”æ¡ˆæœ‰ ${fileData.sheets.length} å€‹å·¥ä½œè¡¨</div></div>`:''}<div class="form-group"><label>æª”æ¡ˆæ¨™ç±¤</label><input type="text" id="label_${i}" value="${fileLabel}" readonly style="background:#f8f9fa;"><div class="helper-text">æ ¼å¼ï¼šæª”æ¡ˆåç¨±_å·¥ä½œè¡¨åç¨±</div></div><div class="form-group"><label>Key æ¬„ä½ï¼ˆå¯è¤‡é¸ï¼‰</label><div class="key-selector">${selectedSheet.columns.map(col=>`<div class="key-item" onclick="toggleKeyCheckbox(${i},'${col.replace(/'/g,"\\'")}')"><input type="checkbox" id="key_${i}_${col}" value="${col}" onclick="event.stopPropagation();validateKeys(${i})"><label for="key_${i}_${col}">${col}</label></div>`).join('')}</div><div class="helper-text">é¸æ“‡ç”¨æ–¼æ¯”å°çš„é—œéµæ¬„ä½</div><div id="keyValidation_${i}"></div><div id="keyDisplay_${i}"></div></div></div></div>`;
}).join('');
}

function changeSheet(fileIndex,sheetIndex){
filesData[fileIndex].selectedSheetIndex=parseInt(sheetIndex);
displayFiles();
updatePrimarySelector();
displayColumnsSelector();
}

function toggleKeyCheckbox(fileIndex,colName){
const cb=document.getElementById(`key_${fileIndex}_${colName}`);
cb.checked=!cb.checked;
validateKeys(fileIndex);
}

function validateKeys(fileIndex){
const fileData=filesData[fileIndex];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
const validationDiv=document.getElementById(`keyValidation_${fileIndex}`);
const displayDiv=document.getElementById(`keyDisplay_${fileIndex}`);
const selectedKeys=[];

selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`key_${fileIndex}_${col}`);
if(cb&&cb.checked)selectedKeys.push(col);
});

if(selectedKeys.length===0){
validationDiv.innerHTML='';
displayDiv.innerHTML='';
displayColumnsSelector();
return;
}

displayDiv.innerHTML=`<div class="key-display"><strong>æ¯”å°éµå€¼ï¼š</strong>${selectedKeys.join(' + ')}</div>`;

const keyValues=new Set();
let hasDuplicate=false;

selectedSheet.data.forEach(row=>{
const compositeKey=selectedKeys.map(k=>String(row[k]||'')).join('|');
if(keyValues.has(compositeKey))hasDuplicate=true;
keyValues.add(compositeKey);
});

const uniqueCount=keyValues.size;
const totalCount=selectedSheet.data.length;

validationDiv.innerHTML=hasDuplicate?
`<div class="key-validation error">âš ï¸ è­¦å‘Šï¼šKey çµ„åˆæœ‰é‡è¤‡ï¼å”¯ä¸€ï¼š${uniqueCount} / ç¸½ï¼š${totalCount}</div>`:
`<div class="key-validation success">âœ“ Key å”¯ä¸€ï¼ˆ${uniqueCount} ç­†ï¼‰</div>`;

displayColumnsSelector();
}

function removeFile(index){
uploadedFiles.splice(index,1);
filesData.splice(index,1);
displayFiles();
if(uploadedFiles.length<2){
document.getElementById('configSection').style.display='none';
document.getElementById('outputSection').style.display='none';
document.getElementById('resultSection').style.display='none';
}else{
updatePrimarySelector();
displayColumnsSelector();
}
}

function selectMode(radio){
document.querySelectorAll('.mode-option').forEach(opt=>opt.classList.remove('selected'));
radio.parentElement.classList.add('selected');
document.getElementById('primarySelector').style.display=radio.value==='primary'?'block':'none';
}

function updatePrimarySelector(){
const select=document.getElementById('primaryFile');
select.innerHTML=uploadedFiles.map((f,i)=>{
const label=document.getElementById(`label_${i}`)?.value||`æª”æ¡ˆ ${i+1}`;
return`<option value="${i}">${label}</option>`;
}).join('');
}

function displayColumnsSelector(){
const container=document.getElementById('columnsContainer');
let html='';

uploadedFiles.forEach((file,fileIndex)=>{
const fileData=filesData[fileIndex];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
const label=document.getElementById(`label_${fileIndex}`)?.value||`æª”æ¡ˆ ${fileIndex+1}`;
const selectedKeys=new Set();

selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`key_${fileIndex}_${col}`);
if(cb&&cb.checked)selectedKeys.add(col);
});

html+=`<div class="file-columns-group">
<div class="file-columns-header">
<div class="file-columns-title">${label}</div>
<div style="display:flex;gap:10px;">
<button class="btn btn-small" style="background:#28a745;color:white;" onclick="selectFileColumns(${fileIndex})">å…¨é¸</button>
<button class="btn btn-small" style="background:#6c757d;color:white;" onclick="deselectFileColumns(${fileIndex})">å–æ¶ˆå…¨é¸</button>
</div>
</div>
<div class="columns-grid">
${selectedSheet.columns.map(col=>{
const isKey=selectedKeys.has(col);
return`<div class="column-item ${isKey?'is-key':''}" onclick="${isKey?'':`toggleColumnCheckbox(${fileIndex},'${col.replace(/'/g,"\\'")}')`}">
<input type="checkbox" id="col_${fileIndex}_${col}" value="${col}" ${isKey?'disabled':'checked'} onclick="event.stopPropagation()">
<label>${col}</label>
</div>`;
}).join('')}
</div>
</div>`;
});

container.innerHTML=html;
}

function toggleColumnCheckbox(fileIndex,colName){
const cb=document.getElementById(`col_${fileIndex}_${colName}`);
if(!cb.disabled)cb.checked=!cb.checked;
}

function selectFileColumns(fileIndex){
const fileData=filesData[fileIndex];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`col_${fileIndex}_${col}`);
if(cb&&!cb.disabled)cb.checked=true;
});
}

function deselectFileColumns(fileIndex){
const fileData=filesData[fileIndex];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`col_${fileIndex}_${col}`);
if(cb&&!cb.disabled)cb.checked=false;
});
}

function clearAll(){
if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°é–‹å§‹ï¼Ÿ')){
uploadedFiles=[];filesData=[];analysisResults=null;
chartInstances.forEach(c=>c.destroy());chartInstances=[];
document.getElementById('uploadedFiles').innerHTML='';
document.getElementById('configSection').style.display='none';
document.getElementById('outputSection').style.display='none';
document.getElementById('resultSection').style.display='none';
fileInput.value='';
}
}

function performAnalysis(){
const config=[];
const mode=document.querySelector('input[name="mode"]:checked').value;
let keyDisplayFileIndex=0;

if(mode==='primary'){
keyDisplayFileIndex=parseInt(document.getElementById('primaryFile').value);
if(isNaN(keyDisplayFileIndex)||keyDisplayFileIndex<0||keyDisplayFileIndex>=uploadedFiles.length){
alert("è«‹é¸æ“‡æœ‰æ•ˆçš„ä¸»æª”æ¡ˆ");return;
}
}

for(let i=0;i<uploadedFiles.length;i++){
const fileData=filesData[i];
const selectedSheet=fileData.sheets[fileData.selectedSheetIndex];
const label=document.getElementById(`label_${i}`).value.trim()||`æª”æ¡ˆ${i+1}`;
const keys=[];
selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`key_${i}_${col}`);
if(cb&&cb.checked)keys.push(col);
});
if(keys.length===0){alert(`è«‹ç‚ºã€Œ${label}ã€è‡³å°‘é¸ä¸€å€‹ Key`);return;}

const outputColumns=[];
selectedSheet.columns.forEach(col=>{
const cb=document.getElementById(`col_${i}_${col}`);
if(cb&&cb.checked&&!cb.disabled)outputColumns.push(col);
});

config.push({label,keys,outputColumns,data:selectedSheet.data,columns:selectedSheet.columns});
}

const allKeysMap=new Map();
config.forEach((cfg,fileIndex)=>{
cfg.data.forEach(row=>{
const keyValues=cfg.keys.map(k=>String(row[k]||'').trim());
const compositeKey=keyValues.join('|');
if(compositeKey&&!keyValues.every(v=>v==='')){
if(!allKeysMap.has(compositeKey))allKeysMap.set(compositeKey,{keyValues,fileIndices:[]});
allKeysMap.get(compositeKey).fileIndices.push(fileIndex);
}
});
});

let targetKeys=[];
if(mode==='union'){
targetKeys=Array.from(allKeysMap.keys());
}else if(mode==='intersection'){
allKeysMap.forEach((v,key)=>{
if([...new Set(v.fileIndices)].length===uploadedFiles.length)targetKeys.push(key);
});
}else if(mode==='primary'){
config[keyDisplayFileIndex].data.forEach(row=>{
const keyValues=config[keyDisplayFileIndex].keys.map(k=>String(row[k]||'').trim());
const compositeKey=keyValues.join('|');
if(compositeKey&&!keyValues.every(v=>v==='')&&!targetKeys.includes(compositeKey))targetKeys.push(compositeKey);
});
}

const results=[];
targetKeys.forEach(compositeKey=>{
const keyInfo=allKeysMap.get(compositeKey);
const rowData=config.map((cfg,i)=>cfg.data.find(r=>{
const keyValues=cfg.keys.map(k=>String(r[k]||'').trim());
return keyValues.join('|')===compositeKey;
})||null);

const existCount=rowData.filter(r=>r!==null).length;
let category=existCount===uploadedFiles.length?'match':existCount===1?`only_${rowData.findIndex(r=>r!==null)}`:'partial';

results.push({compositeKey,keyValues:keyInfo.keyValues,rowData,category,existCount});
});

analysisResults={results,config,mode,keyDisplayFileIndex};
displayResults();
}

function displayResults(){
const{results,config,keyDisplayFileIndex}=analysisResults;
const stats={total:results.length,match:results.filter(r=>r.category==='match').length,partial:results.filter(r=>r.category==='partial').length};

uploadedFiles.forEach((_,i)=>{stats[`only_${i}`]=results.filter(r=>r.category===`only_${i}`).length;});

let statsHtml=`<div style="background:rgba(255,255,255,0.15);border-radius:10px;padding:20px;text-align:center;"><div style="font-size:32px;font-weight:700;margin-bottom:8px;">${stats.total}</div><div style="font-size:12px;opacity:0.9;">ç¸½ç­†æ•¸</div></div><div style="background:rgba(255,255,255,0.15);border-radius:10px;padding:20px;text-align:center;"><div style="font-size:32px;font-weight:700;margin-bottom:8px;color:#4ade80;">${stats.match}</div><div style="font-size:12px;opacity:0.9;">å®Œå…¨ç›¸ç¬¦</div></div>`;

uploadedFiles.forEach((_,i)=>{
const count=stats[`only_${i}`]||0;
if(count>0)statsHtml+=`<div style="background:rgba(255,255,255,0.15);border-radius:10px;padding:20px;text-align:center;"><div style="font-size:32px;font-weight:700;margin-bottom:8px;color:#fb923c;">${count}</div><div style="font-size:12px;opacity:0.9;">åƒ…${config[i].label}</div></div>`;
});

if(stats.partial>0)statsHtml+=`<div style="background:rgba(255,255,255,0.15);border-radius:10px;padding:20px;text-align:center;"><div style="font-size:32px;font-weight:700;margin-bottom:8px;color:#60a5fa;">${stats.partial}</div><div style="font-size:12px;opacity:0.9;">éƒ¨åˆ†ç¼ºå¤±</div></div>`;

document.getElementById('statsGrid').innerHTML=statsHtml;

const matchRate=stats.total>0?((stats.match/stats.total)*100).toFixed(1):0;
let summaryHtml=`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);"><span style="opacity:0.9;">ç›¸ç¬¦ç‡</span><span style="font-weight:600;">${matchRate}%</span></div>`;

uploadedFiles.forEach((f,i)=>{
const count=results.filter(r=>r.rowData[i]!==null).length;
const coverage=stats.total>0?((count/stats.total)*100).toFixed(1):0;
summaryHtml+=`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);"><span style="opacity:0.9;">${config[i].label} è¦†è“‹ç‡</span><span style="font-weight:600;">${coverage}%</span></div>`;
});

document.getElementById('summaryBox').innerHTML=summaryHtml;
drawCharts(stats,config,results);
generateTabs(stats,config);
document.getElementById('resultSection').style.display='block';
document.getElementById('resultSection').scrollIntoView({behavior:'smooth'});
}

function drawCharts(stats,config,results){
chartInstances.forEach(c=>c.destroy());chartInstances=[];
if(typeof Chart==='undefined')return;

const ctx1=document.getElementById('pieChart').getContext('2d');
const labels=[],data=[],colors=[];

if(stats.match>0){labels.push('å®Œå…¨ç›¸ç¬¦');data.push(stats.match);colors.push('#4ade80');}
uploadedFiles.forEach((_,i)=>{
const count=stats[`only_${i}`]||0;
if(count>0){labels.push(`åƒ…${config[i].label}`);data.push(count);colors.push(['#ef4444','#fb923c','#60a5fa','#a78bfa'][i%4]);}
});
if(stats.partial>0){labels.push('éƒ¨åˆ†ç¼ºå¤±');data.push(stats.partial);colors.push('#94a3b8');}

chartInstances.push(new Chart(ctx1,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:true}}));

const ctx2=document.getElementById('barChart').getContext('2d');
const coverage=uploadedFiles.map((_,i)=>{
const count=results.filter(r=>r.rowData[i]!==null).length;
return stats.total>0?((count/stats.total)*100).toFixed(1):0;
});

chartInstances.push(new Chart(ctx2,{type:'bar',data:{labels:config.map(c=>c.label),datasets:[{label:'è¦†è“‹ç‡ (%)',data:coverage,backgroundColor:'#667eea'}]},options:{responsive:true,maintainAspectRatio:true,scales:{y:{beginAtZero:true,max:100}}}}));
}

function generateTabs(stats,config){
let tabsHtml=`<button style="padding:10px 18px;border:none;background:#667eea;color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;" onclick="switchTab('all',event)">å…¨éƒ¨ <span style="background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:10px;font-size:11px;">${stats.total}</span></button>`;

if(stats.match>0)tabsHtml+=`<button style="padding:10px 18px;border:none;background:#e9ecef;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;" onclick="switchTab('match',event)">å®Œå…¨ç›¸ç¬¦ <span style="background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:10px;font-size:11px;">${stats.match}</span></button>`;

uploadedFiles.forEach((_,i)=>{
const count=stats[`only_${i}`]||0;
if(count>0)tabsHtml+=`<button style="padding:10px 18px;border:none;background:#e9ecef;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;" onclick="switchTab('only_${i}',event)">åƒ…${config[i].label} <span style="background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:10px;font-size:11px;">${count}</span></button>`;
});

if(stats.partial>0)tabsHtml+=`<button style="padding:10px 18px;border:none;background:#e9ecef;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;" onclick="switchTab('partial',event)">éƒ¨åˆ†ç¼ºå¤± <span style="background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:10px;font-size:11px;">${stats.partial}</span></button>`;

document.getElementById('tabs').innerHTML=tabsHtml;
switchTab('all');
}

function switchTab(categoryId,event){
if(event){
document.querySelectorAll('#tabs button').forEach(tab=>{tab.style.background='#e9ecef';tab.style.color='#333';});
event.currentTarget.style.background='#667eea';
event.currentTarget.style.color='white';
}

const{results,config,keyDisplayFileIndex}=analysisResults;
const filtered=categoryId==='all'?results:results.filter(r=>r.category===categoryId);
const content=document.getElementById('tabContent');

if(filtered.length===0){
content.innerHTML='<p style="text-align:center;padding:40px;color:#999;">ç„¡è³‡æ–™</p>';
return;
}

let tableHtml='<table class="data-table"><thead><tr>';

config[keyDisplayFileIndex].keys.forEach(keyName=>{
tableHtml+=`<th>${keyName}</th>`;
});

config.forEach(cfg=>{
cfg.outputColumns.forEach(col=>{
tableHtml+=`<th>${cfg.label}_${col}</th>`;
});
});

tableHtml+='</tr></thead><tbody>';

filtered.forEach(r=>{
let bg='#ffffff',c='#000000';
if(r.category==='match'){bg='#e8f5e9';c='#1b5e20';}
else if(r.category==='partial'){bg='#fff8e1';c='#8a6d3b';}
else if(r.category.startsWith('only_')){
const i=parseInt(r.category.split('_')[1])%5;
const p=['#ffebee','#e3f2fd','#f3e5f5','#fff3e0','#e8f5e9'];
const t=['#c62828','#1565c0','#6a1b9a','#ef6c00','#2e7d32'];
bg=p[i];c=t[i];
}

tableHtml+=`<tr style="background:${bg}!important;color:${c};">`;

config[keyDisplayFileIndex].keys.forEach((_,j)=>{
tableHtml+=`<td><strong>${r.keyValues[j]||'-'}</strong></td>`;
});

config.forEach((cfg,fi)=>{
cfg.outputColumns.forEach(col=>{
tableHtml+=`<td>${r.rowData[fi]?.[col]??'-'}</td>`;
});
});

tableHtml+='</tr>';
});

tableHtml+='</tbody></table>';
content.innerHTML=tableHtml;
}

function exportResults(){
if(!analysisResults)return;
const{results,config,keyDisplayFileIndex}=analysisResults;
const wb=XLSX.utils.book_new();
const summary=[['è³‡æ–™æ¯”å°å ±å‘Š'],['ç”¢ç”Ÿæ™‚é–“',new Date().toLocaleString('zh-TW')],[''],['æª”æ¡ˆè³‡è¨Š']];

config.forEach((cfg,i)=>{
summary.push([`æª”æ¡ˆ ${i+1}`,cfg.label,uploadedFiles[i].name]);
summary.push(['Key æ¬„ä½',cfg.keys.join(' + ')]);
});

summary.push([''],['çµ±è¨ˆ'],['ç¸½ç­†æ•¸',results.length]);
XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(summary),'æ‘˜è¦');

const detailData=results.map(row=>{
const obj={};
config[keyDisplayFileIndex].keys.forEach((keyName,idx)=>{
obj[keyName]=row.keyValues[idx];
});
config.forEach(cfg=>{
const fileIndex=config.indexOf(cfg);
cfg.outputColumns.forEach(col=>{
const data=row.rowData[fileIndex];
obj[`${cfg.label}_${col}`]=data&&data[col]!==undefined?data[col]:'';
});
});
return obj;
});

XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(detailData),'è©³ç´°è³‡æ–™');
XLSX.writeFile(wb,`æ¯”å°å ±å‘Š_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
